<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Lista de Leads</title>
    <script>
        function filterLeads(status) {
            const cards = document.querySelectorAll('.lead-card');
            cards.forEach(card => {
                const leadStatus = card.getAttribute('data-status');
                const invitedElements = card.querySelectorAll('.invited');
                const acceptedElements = card.querySelectorAll('.accepted');

                if (status === 'ALL') {
                    card.style.display = '';
                    invitedElements.forEach(el => el.style.display = '');
                    acceptedElements.forEach(el => el.style.display = '');
                } else if (status === 'INVITED') {
                    if (leadStatus === 'INVITED') {
                        card.style.display = '';
                        invitedElements.forEach(el => el.style.display = '');
                        acceptedElements.forEach(el => el.style.display = 'none');
                    } else {
                        card.style.display = 'none';
                    }
                } else if (status === 'ACCEPTED') {
                    if (leadStatus === 'ACCEPTED') {
                        card.style.display = '';
                        invitedElements.forEach(el => el.style.display = 'none');
                        acceptedElements.forEach(el => el.style.display = '');
                    } else {
                        card.style.display = 'none';
                    }
                } else {
                    card.style.display = 'none';
                }
            });

            // Atualizar botões ativos
            document.querySelectorAll('.btn.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.btn[onclick="filterLeads('${status}')"]`).classList.add('active');
        } function acceptLead(button, leadId) {
            console.log('Aceitando lead com ID:', leadId);
            fetch(`/leads/accept/${leadId}`, {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao aceitar o lead.');
                    }
                    return response.json();
                })
                .then(data => {
                    const card = button.closest('.lead-card');
                    card.setAttribute('data-status', 'ACCEPTED');

                    // Hide invited elements and show accepted elements
                    card.querySelectorAll('.invited').forEach(el => el.style.display = 'none');
                    card.querySelectorAll('.accepted').forEach(el => el.style.display = '');

                    // Update the status text
                    const statusElement = card.querySelector('li:last-child span');
                    if (statusElement) {
                        statusElement.textContent = 'ACCEPTED';
                    }
                    console.log('Lead aceito com sucesso!', data);

                    // Reaplicar o filtro atual
                    const activeFilter = document.querySelector('.btn.active')?.dataset.filter || 'INVITED';
                    filterLeads(activeFilter);
                })
                .catch(error => {
                    console.error('Erro ao aceitar lead:', error);
                    alert('Não foi possível aceitar o lead. Tente novamente.');
                });
        }
        function declineLead(button, leadId) {
            console.log('Recusando lead com ID:', leadId);
            fetch(`/leads/decline/${leadId}`, {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao aceitar o lead.');
                    }
                    return response.json();
                })
                .then(data => {
                    const card = button.closest('.lead-card');
                    card.setAttribute('data-status', 'ACCEPTED');

                    card.querySelectorAll('.invited').forEach(el => el.style.display = 'none');
                    card.querySelectorAll('.accepted').forEach(el => el.style.display = '');

                    const statusElement = card.querySelector('li:last-child span');
                    if (statusElement) {
                        statusElement.textContent = 'ACCEPTED';
                    }
                    console.log('Lead aceito com sucesso!', data);

                    // Reaplicar o filtro atual
                    const activeFilter = document.querySelector('.btn.active')?.dataset.filter || 'INVITED';
                    filterLeads(activeFilter);
                })
                .catch(error => {
                    console.error('Erro ao aceitar lead:', error);
                    alert('Não foi possível aceitar o lead. Tente novamente.');
                });
        }


        document.addEventListener('DOMContentLoaded', function () {
            filterLeads('INVITED'); // Filtrar inicialmente para INVITED
        });
    </script>
</head>

<body>
    <div class="container mt-4">
        <h2>Leads Cadastrados</h2>

        <div class="mb-3">
            <button class="btn btn-primary filter-btn" onclick="filterLeads('INVITED')">Mostrar INVITED</button>
            <button class="btn btn-success filter-btn" onclick="filterLeads('ACCEPTED')">Mostrar ACCEPTED</button>
        </div>
        <div class="row" id="leadsContainer">
            <div class="col-md-4 mb-4" th:each="lead : ${leads}">
                <div class="card lead-card h-100" th:attr="data-status=${lead.status}">
                    <div class="card-body">
                        <h5 class="card-title">
                            <span class="invited" th:text="${lead.firstName}"></span>
                            <span class="accepted" th:text="${lead.firstName}"></span>
                        </h5>
                        <ul class="list-unstyled"></ul>
                        <li class="accepted" th:text="'Email: ' + ${lead.email}"></li>
                        <li class="accepted" th:text="'Telefone: ' + ${lead.phone}"></li>
                        <li>Data de Criação: <span th:text="${#dates.format(lead.dateCreated, 'dd/MM/yyyy')}"></span>
                        </li>
                        <li>Bairro: <span th:text="${lead.suburb}"></span></li>
                        <li>Categoria: <span th:text="${lead.category}"></span></li>
                        <li>Descrição: <span th:text="${lead.description}"></span></li>
                        <li>Preço: R$<span th:text="${lead.price}"></span></li>
                        <li>Status: <span th:text="${lead.status}"></span></li>
                        <li class="invited">
                            <button class="btn btn-success invited"
                                th:onclick="|acceptLead(this, '${lead.id}')|">Accept</button>
                        </li>
                        <li class="invited">
                            <button class="btn btn-success invited"
                                th:onclick="|declineLead(this, '${lead.id}')|">Decline</button>
                        </li>
                        
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <h3 class="mt-5">Cadastrar Novo Lead</h3>
        <form th:action="@{/leads/save}" method="post" class="row g-3 mt-3">
            <div class="col-md-6"></div>
            <label for="firstName" class="form-label">Primeiro Nome</label>
            <input type="text" class="form-control" id="firstName" name="firstName" required>
    </div>
    <div class="col-md-6">
        <label for="lastName" class="form-label">Último Nome</label>
        <input type="text" class="form-control" id="lastName" name="lastName" required>
    </div>
    <div class="col-md-6">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" id="email" name="email" required>
    </div>
    <div class="col-md-6">
        <label for="phone" class="form-label">Telefone</label>
        <input type="text" class="form-control" id="phone" name="phone" required>
    </div>
    <div class="col-md-6">
        <label for="suburb" class="form-label">Bairro</label>
        <input type="text" class="form-control" id="suburb" name="suburb" required>
    </div>
    <div class="col-md-6">
        <label for="category" class="form-label">Categoria</label>
        <input type="text" class="form-control" id="category" name="category" required>
    </div>
    <div class="col-md-12">
        <label for="description" class="form-label">Descrição</label>
        <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
    </div>
    <div class="col-md-6">
        <label for="price" class="form-label">Preço</label>
        <input type="number" class="form-control" id="price" name="price" step="0.01" required>
    </div>
    <div class="col-md-6">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status" name="status" required>
            <option value="INVITED">INVITED</option>
            <option value="ACCEPTED">ACCEPTED</option>
        </select>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-primary">Cadastrar</button>
    </div>
    </form>
    </div>
</body>

</html>